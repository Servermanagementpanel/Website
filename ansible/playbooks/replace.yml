---
- name: Playbook zum Einlesen und Verwenden von Variablen
  hosts: staging
  gather_facts: no

  vars_files:
    - de-de.yml

  vars:
    branch: origin/Variables
    html_files_path: "/var/www/html/website"
    header_file: "/var/www/html/website/header.html"
    footer_file: "/var/www/html/website/footer.html"
    list:
    - /var/www/html/website/index.html
    - /var/www/html/website/GTC/index.html
    - /var/www/html/website/GTC/GTC/index.html
    - /var/www/html/website/contact/index.html
    - /var/www/html/website/Datenschutz/index.html
    - /var/www/html/website/Impressum/index.html

  tasks:
    - name: Ping
      ansible.builtin.ping:

    - name: Stop NginX
      become: yes
      become_user: root
      ansible.builtin.service:
        name: nginx
        state: stopped

    - name: Git Fetch
      ansible.builtin.command: git fetch --all
      become: yes
      become_user: root
      args:
        chdir: /var/www/html/website

    - name: Git Reset
      ansible.builtin.command: git reset --hard "{{ branch }}"
      become: yes
      become_user: root
      args:
        chdir: /var/www/html/website

    - name: Finde alle .html-Dateien im relativen Pfad
      find:
        paths: "/var/www/html/website/"
        patterns: "*.html"
        recurse: yes
      register: html_files

    - name: Lese den Inhalt der .html-Dateien ein
      slurp:
        src: "{{ item.path }}"
      loop: "{{ html_files.files }}"
      register: html_contents

    # - name: Debug Variablen
    #   ansible.builtin.debug:
    #     var: html_contents

    # - name: Debug Replacements
    #   ansible.builtin.debug:
    #     var: replacements

    - name: Ersetze Variablen in HTML-Dateien
      become: yes
      become_user: root
      replace:
        path: "{{ item.0.source }}"
        regexp: "{{ item.1.key }}"
        replace: "{{ item.1.value }}"
      loop: "{{ html_contents.results | product(replacements | dict2items) | list }}"
      loop_control:
        label: "Replacing {{ item.1.key }} in {{ item.0.source | basename }}"

    # - name: Ersetze Variablen in HTML-Dateien
    #   ansible.builtin.debug:
    #     msg:
    #     - "html_contents: {{ html_contents | to_json }}"
    #     - "replacements: {{ replacements | to_json }}"
    #   failed_when: replacements is undefined or not replacements is mapping
    #   vars:
    #     error_msg: "replacements muss ein definiertes Dictionary sein"+

    - name: Read the content of header.html
      slurp:
        src: "{{ header_file }}"
      register: header_content

    - name: Replace placeholder with header content
      become: yes
      become_user: root
      lineinfile:
        # path: /var/www/html/website/index.html
        path: "{{ item }}"
        regexp: 'HEADERHEADERHEADER'
        line: "{{ header_content.content | b64decode }}"
      loop: "{{ list }}"

    - name: Read the content of footer.html
      slurp:
        src: "{{ footer_file }}"
      register: footer_content

    - name: Replace placeholder with footer content
      become: yes
      become_user: root
      lineinfile:
        # path: /var/www/html/website/index.html
        path: "{{ item }}"
        regexp: 'FOOTERFOOTERFOOTER'
        line: "{{ footer_content.content | b64decode }}"
      loop: "{{ list }}"
    
    - name: Start NginX
      become: yes
      become_user: root
      ansible.builtin.service:
        name: nginx
        state: started
